<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaluaciÃ³n de Calidad del Servicio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&family=DM+Serif+Display&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.7/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #f8f7f4;
    --surface: #ffffff;
    --surface-alt: #faf9f7;
    --sidebar-bg: #1a1a2e;
    --sidebar-hover: #25254a;
    --sidebar-active: #2d2d5e;
    --accent: #5b5fc7;
    --accent-light: #8385d6;
    --accent-glow: rgba(91,95,199,.12);
    --text-primary: #1a1a2e;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;
    --border: #e8e6e1;
    --border-light: #f0eeea;

    --green-5: #22c55e;
    --green-4: #6ee7a0;
    --yellow-3: #eab308;
    --red-2: #f97066;
    --red-1: #dc2626;

    --green-5-soft: #dcfce7;
    --green-4-soft: #ecfdf5;
    --yellow-3-soft: #fef9c3;
    --red-2-soft: #fee2e2;
    --red-1-soft: #fecaca;

    --yes: #22c55e;
    --no: #ef4444;
    --yes-soft: #dcfce7;
    --no-soft: #fee2e2;

    --radius: 14px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,.04);
    --shadow-md: 0 4px 16px rgba(0,0,0,.06);
    --shadow-lg: 0 8px 32px rgba(0,0,0,.08);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    display: flex;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘            SIDEBAR                    â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .sidebar {
    position: fixed; top: 0; left: 0; bottom: 0;
    width: 300px;
    background: var(--sidebar-bg);
    color: #e2e1f0;
    display: flex; flex-direction: column;
    z-index: 100;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #3a3a6a transparent;
  }

  .sidebar-header {
    padding: 32px 28px 24px;
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .sidebar-header .brand {
    font-family: 'DM Serif Display', serif;
    font-size: 1.35rem;
    color: #fff;
    line-height: 1.3;
    margin-bottom: 4px;
  }
  .sidebar-header .brand em {
    font-style: normal;
    background: linear-gradient(135deg, #8385d6, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .sidebar-header .subtitle {
    font-size: 0.72rem;
    color: #7a7aad;
    letter-spacing: .03em;
  }

  .sidebar-body {
    padding: 24px 28px;
    flex: 1;
    display: flex; flex-direction: column; gap: 24px;
  }

  .ctrl-group { display: flex; flex-direction: column; gap: 8px; }
  .ctrl-label {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .12em;
    color: #7a7aad;
  }

  .sidebar select {
    width: 100%;
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    border: 1.5px solid rgba(255,255,255,.1);
    background: rgba(255,255,255,.05);
    color: #e2e1f0;
    font-family: inherit;
    font-size: 0.82rem;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237a7aad' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
  }
  .sidebar select:focus {
    outline: none;
    border-color: var(--accent-light);
    box-shadow: 0 0 0 3px rgba(131,133,214,.2);
  }
  .sidebar select option { background: #1a1a2e; }

  .chart-type-btns {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
  }
  .chart-type-btns button {
    padding: 8px 4px;
    font-family: inherit;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: var(--radius-sm);
    border: 1.5px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    color: #7a7aad;
    cursor: pointer;
    transition: all .2s;
    display: flex; flex-direction: column; align-items: center; gap: 3px;
  }
  .chart-type-btns button .icon { font-size: 1rem; }
  .chart-type-btns button:hover { background: rgba(255,255,255,.06); color: #c4c3e2; }
  .chart-type-btns button.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    box-shadow: 0 2px 12px rgba(91,95,199,.4);
  }

  .color-legend {
    padding: 14px 16px;
    background: rgba(0,0,0,.2);
    border-radius: 10px;
    display: flex; flex-direction: column; gap: 6px;
  }
  .color-legend .row {
    display: flex; align-items: center; gap: 10px;
    font-size: 0.73rem; color: #b0afcf;
  }
  .color-legend .swatch {
    width: 14px; height: 14px;
    border-radius: 4px; flex-shrink: 0;
  }

  .sidebar-actions {
    padding: 20px 28px 28px;
    border-top: 1px solid rgba(255,255,255,.06);
    display: flex; flex-direction: column; gap: 8px;
  }
  .sidebar-actions button {
    width: 100%; padding: 11px 16px;
    font-family: inherit; font-size: 0.82rem; font-weight: 600;
    border-radius: var(--radius-sm);
    cursor: pointer; transition: all .2s;
    border: none;
  }
  .btn-print {
    background: linear-gradient(135deg, var(--accent), #7c3aed);
    color: #fff;
    box-shadow: 0 2px 12px rgba(91,95,199,.3);
  }
  .btn-print:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(91,95,199,.4); }

  /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘            MAIN CONTENT               â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .main {
    margin-left: 300px;
    flex: 1;
    padding: 40px 48px 60px;
    max-width: 100%;
    min-width: 0;
  }

  /* Hero header */
  .page-header {
    margin-bottom: 32px;
  }
  .page-header .top-row {
    display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;
    flex-wrap: wrap;
  }
  .page-header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    font-weight: 400;
    letter-spacing: -.01em;
    line-height: 1.2;
    color: var(--text-primary);
  }
  .page-header h1 .plantel-name {
    display: block;
    background: linear-gradient(135deg, var(--accent), #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .page-header .response-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--accent-glow);
    color: var(--accent);
    padding: 8px 18px;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 700;
    white-space: nowrap;
  }
  .page-header .response-badge .num {
    font-family: 'DM Serif Display', serif;
    font-size: 1.3rem;
  }

  /* KPI cards */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 40px;
  }
  .kpi-card {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 22px 26px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
    position: relative;
    overflow: hidden;
  }
  .kpi-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
  }
  .kpi-card.green::before { background: linear-gradient(90deg, #22c55e, #6ee7a0); }
  .kpi-card.yellow::before { background: linear-gradient(90deg, #eab308, #fde047); }
  .kpi-card.red::before { background: linear-gradient(90deg, #ef4444, #f97066); }
  .kpi-card.purple::before { background: linear-gradient(90deg, var(--accent), #c084fc); }
  .kpi-card .kpi-label {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .08em;
    color: var(--text-tertiary);
    margin-bottom: 8px;
  }
  .kpi-card .kpi-value {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    line-height: 1;
  }
  .kpi-card .kpi-sub {
    font-size: 0.72rem;
    color: var(--text-secondary);
    margin-top: 4px;
  }

  /* Section headings */
  .section-heading {
    display: flex; align-items: center; gap: 12px;
    margin: 44px 0 24px;
    padding-bottom: 14px;
    border-bottom: 2px solid var(--border);
  }
  .section-heading .icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem;
  }
  .section-heading .icon.likert { background: linear-gradient(135deg, #dcfce7, #fef9c3, #fee2e2); }
  .section-heading .icon.yesno { background: linear-gradient(135deg, #dcfce7, #fee2e2); }
  .section-heading h2 {
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .1em;
    color: var(--text-secondary);
  }
  .section-heading .count {
    margin-left: auto;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-tertiary);
    background: var(--surface-alt);
    padding: 4px 12px;
    border-radius: 50px;
  }

  /* Chart grid */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
    gap: 20px;
  }

  /* Chart cards */
  .chart-card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
    box-shadow: var(--shadow-sm);
    padding: 0;
    overflow: hidden;
    transition: box-shadow .25s, transform .25s;
    break-inside: avoid;
  }
  .chart-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .card-top {
    padding: 24px 28px 0;
  }
  .card-top .q-number {
    font-size: 0.62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .1em;
    color: var(--accent);
    margin-bottom: 6px;
  }
  .card-top h3 {
    font-size: 0.88rem;
    font-weight: 600;
    line-height: 1.5;
    color: var(--text-primary);
  }

  /* Horizontal stacked bar */
  .stacked-bar-wrap {
    padding: 16px 28px 0;
  }
  .stacked-bar {
    display: flex;
    height: 12px;
    border-radius: 6px;
    overflow: hidden;
    background: var(--border-light);
  }
  .stacked-bar .seg {
    transition: width .5s cubic-bezier(.4,0,.2,1);
    position: relative;
  }
  .stacked-bar .seg:first-child { border-radius: 6px 0 0 6px; }
  .stacked-bar .seg:last-child { border-radius: 0 6px 6px 0; }

  /* Breakdown pills */
  .breakdown {
    display: flex; flex-wrap: wrap; gap: 6px;
    padding: 12px 28px 0;
  }
  .pill {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 0.7rem;
    color: var(--text-secondary);
    background: var(--surface-alt);
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid var(--border-light);
  }
  .pill .dot {
    width: 8px; height: 8px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .pill strong { color: var(--text-primary); font-weight: 700; }

  /* Canvas area */
  .chart-area {
    padding: 16px 24px 24px;
    position: relative;
  }
  .chart-area canvas {
    width: 100% !important;
    max-height: 280px;
  }

  /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘            LOADING                    â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .loader-overlay {
    position: fixed; inset: 0;
    background: rgba(248,247,244,.9);
    backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    z-index: 999;
    transition: opacity .3s;
  }
  .loader-overlay.hidden { opacity: 0; pointer-events: none; }
  .loader-spinner {
    width: 44px; height: 44px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .65s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Entrance animation */
  .chart-card { animation: cardIn .4s ease both; }
  @keyframes cardIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘            PRINT STYLES               â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @media print {
    body { background: #fff !important; }
    .sidebar { display: none !important; }
    .main { margin-left: 0 !important; padding: 16px !important; }
    .charts-grid { grid-template-columns: 1fr 1fr !important; gap: 12px !important; }
    .chart-card {
      break-inside: avoid;
      box-shadow: none !important;
      border: 1px solid #ddd !important;
      transform: none !important;
    }
    .chart-card:hover { transform: none !important; }
    .stacked-bar .seg, .pill .dot, .color-legend .swatch,
    .kpi-card::before, .kpi-card, .response-badge {
      print-color-adjust: exact !important;
      -webkit-print-color-adjust: exact !important;
    }
    .page-header h1 .plantel-name {
      -webkit-text-fill-color: var(--accent) !important;
    }
    .chart-area canvas { max-height: 220px !important; }
  }

  /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘            RESPONSIVE                 â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @media (max-width: 900px) {
    .sidebar { width: 260px; }
    .main { margin-left: 260px; padding: 24px; }
    .charts-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 640px) {
    .sidebar {
      position: relative; width: 100%;
      flex-direction: row; flex-wrap: wrap;
      padding: 16px;
    }
    .main { margin-left: 0; padding: 16px; }
  }
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-header">
    <div class="brand">EvaluaciÃ³n de<br><em>Calidad del Servicio</em></div>
    <div class="subtitle">IECS Â· IEDIS â€” Dashboard de Resultados</div>
  </div>

  <div class="sidebar-body">
    <div class="ctrl-group">
      <span class="ctrl-label">Plantel</span>
      <select id="selPlantel"></select>
    </div>

    <div class="ctrl-group">
      <span class="ctrl-label">Tipo de GrÃ¡fica</span>
      <div class="chart-type-btns" id="chartTypeBtns">
        <button data-type="bar" class="active"><span class="icon">â–</span>Barras</button>
        <button data-type="horizontalBar"><span class="icon">â–¬</span>H-Barras</button>
        <button data-type="doughnut"><span class="icon">â—</span>Dona</button>
        <button data-type="pie"><span class="icon">â—•</span>Pastel</button>
        <button data-type="polarArea"><span class="icon">âœ¦</span>Polar</button>
        <button data-type="radar"><span class="icon">â—‡</span>Radar</button>
      </div>
    </div>

    <div class="ctrl-group">
      <span class="ctrl-label">Filtrar Preguntas</span>
      <select id="selFilter">
        <option value="all">Todas las preguntas</option>
        <option value="likert5">Escala de satisfacciÃ³n (5 pts)</option>
        <option value="yesno">SÃ­ / No</option>
      </select>
    </div>

    <div class="ctrl-group">
      <span class="ctrl-label">CÃ³digo de Colores</span>
      <div class="color-legend" id="colorLegend"></div>
    </div>
  </div>

  <div class="sidebar-actions">
    <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
  </div>
</aside>

<div class="main">
  <div class="loader-overlay" id="loader"><div class="loader-spinner"></div></div>

  <div class="page-header">
    <div class="top-row">
      <h1>Resultados por Plantel<span class="plantel-name" id="plantelTitle">Cargandoâ€¦</span></h1>
      <div class="response-badge"><span class="num" id="badgeNum">â€“</span>&nbsp;respuestas</div>
    </div>
  </div>

  <div class="kpi-row" id="kpiRow"></div>
  <div id="sectionsContainer"></div>
</div>

<script>
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  COLOR SYSTEM                                                    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const L5 = {
  'Muy satisfecho':   { bg: '#22c55e', soft: '#dcfce7' },
  'Satisfecho':       { bg: '#6ee7a0', soft: '#ecfdf5' },
  'Neutral':          { bg: '#eab308', soft: '#fef9c3' },
  'Insatisfecho':     { bg: '#f97066', soft: '#fee2e2' },
  'Muy insatisfecho': { bg: '#dc2626', soft: '#fecaca' },
};
const YN = {
  'SÃ­': { bg: '#22c55e', soft: '#dcfce7' },
  'No': { bg: '#ef4444', soft: '#fee2e2' },
};

function palette(type, labels) {
  const map = type === 'likert5' ? L5 : YN;
  return labels.map(l => map[l] || { bg: '#d1d5db', soft: '#f3f4f6' });
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  STATE                                                           â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let DATA = null;
let charts = [];
let chartType = 'bar';
let filterType = 'all';
let currentPlantel = '__ALL__';

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  INIT                                                            â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', async () => {
  const res = await fetch('data.json');
  DATA = await res.json();

  const sel = document.getElementById('selPlantel');
  DATA.plantel_list.forEach(key => {
    const o = document.createElement('option');
    o.value = key;
    o.textContent = key === '__ALL__' ? 'ğŸ«  Todos los Planteles' : key;
    sel.appendChild(o);
  });
  sel.addEventListener('change', () => { currentPlantel = sel.value; render(); });

  document.querySelectorAll('#chartTypeBtns button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#chartTypeBtns button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      chartType = btn.dataset.type;
      render();
    });
  });

  document.getElementById('selFilter').addEventListener('change', e => {
    filterType = e.target.value;
    render();
  });

  buildLegend();
  render();
});

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  RENDER                                                          â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render() {
  showLoader(true);
  // Small delay so loader paints
  requestAnimationFrame(() => { requestAnimationFrame(() => { doRender(); showLoader(false); }); });
}

function doRender() {
  const p = DATA.planteles[currentPlantel];
  if (!p) return;

  document.getElementById('plantelTitle').textContent = p.name;
  document.getElementById('badgeNum').textContent = p.total;

  // Destroy old charts
  charts.forEach(c => c.destroy());
  charts = [];

  renderKPIs(p);

  const container = document.getElementById('sectionsContainer');
  container.innerHTML = '';

  let questions = p.questions;
  if (filterType !== 'all') questions = questions.filter(q => q.type === filterType);

  const likert5 = questions.filter(q => q.type === 'likert5');
  const yesno = questions.filter(q => q.type === 'yesno');

  if (likert5.length) {
    container.appendChild(sectionHeading('Preguntas de SatisfacciÃ³n â€” Escala Likert', likert5.length, 'likert'));
    const grid = el('div', 'charts-grid');
    likert5.forEach((q, i) => {
      const card = buildCard(q, i);
      card.style.animationDelay = (i * 40) + 'ms';
      grid.appendChild(card);
    });
    container.appendChild(grid);
  }
  if (yesno.length) {
    container.appendChild(sectionHeading('Preguntas SÃ­ / No', yesno.length, 'yesno'));
    const grid = el('div', 'charts-grid');
    yesno.forEach((q, i) => {
      const card = buildCard(q, i + likert5.length);
      card.style.animationDelay = ((i + likert5.length) * 40) + 'ms';
      grid.appendChild(card);
    });
    container.appendChild(grid);
  }
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  KPI CARDS                                                       â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderKPIs(p) {
  const row = document.getElementById('kpiRow');
  row.innerHTML = '';

  const l5 = p.questions.filter(q => q.type === 'likert5');
  const yn = p.questions.filter(q => q.type === 'yesno');

  if (l5.length) {
    let pos = 0, tot = 0;
    l5.forEach(q => {
      pos += (q.data.find(d => d.label === 'Muy satisfecho')?.count || 0) +
             (q.data.find(d => d.label === 'Satisfecho')?.count || 0);
      tot += q.data.reduce((a, d) => a + d.count, 0);
    });
    const pct = tot > 0 ? (pos / tot * 100).toFixed(1) : 0;
    const cls = pct >= 70 ? 'green' : pct >= 50 ? 'yellow' : 'red';
    row.appendChild(kpiCard('SatisfacciÃ³n positiva', pct + '%', 'Satisfecho + Muy satisfecho', cls));
  }

  if (yn.length) {
    let si = 0, tot = 0;
    yn.forEach(q => {
      si += q.data.find(d => d.label === 'SÃ­')?.count || 0;
      tot += q.data.reduce((a, d) => a + d.count, 0);
    });
    const pct = tot > 0 ? (si / tot * 100).toFixed(1) : 0;
    const cls = pct >= 70 ? 'green' : pct >= 50 ? 'yellow' : 'red';
    row.appendChild(kpiCard('Respuestas "SÃ­"', pct + '%', 'Promedio todas las preguntas', cls));
  }

  row.appendChild(kpiCard('Preguntas Likert', l5.length, 'Escala de 5 puntos', 'purple'));
  row.appendChild(kpiCard('Preguntas SÃ­/No', yn.length, 'Binarias', 'purple'));
}

function kpiCard(label, value, sub, cls) {
  const d = el('div', 'kpi-card ' + cls);
  d.innerHTML = `<div class="kpi-label">${label}</div><div class="kpi-value">${value}</div><div class="kpi-sub">${sub}</div>`;
  return d;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  BUILD SINGLE CHART CARD                                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let qCounter = 0;
function buildCard(q, idx) {
  const card = el('div', 'chart-card');
  const labels = q.data.map(d => d.label);
  const counts = q.data.map(d => d.count);
  const pcts = q.data.map(d => d.pct);
  const pal = palette(q.type, labels);
  const totalCount = counts.reduce((a, b) => a + b, 0);

  // Top section
  const top = el('div', 'card-top');
  top.innerHTML = `<div class="q-number">Pregunta ${idx + 1} Â· ${q.type === 'likert5' ? 'Likert' : 'SÃ­/No'} Â· n=${q.total}</div>
    <h3>${q.question}</h3>`;
  card.appendChild(top);

  // Stacked bar
  const sbWrap = el('div', 'stacked-bar-wrap');
  const sb = el('div', 'stacked-bar');
  q.data.forEach((d, i) => {
    const seg = el('div', 'seg');
    seg.style.width = (totalCount > 0 ? d.count / totalCount * 100 : 0) + '%';
    seg.style.background = pal[i].bg;
    seg.title = `${d.label}: ${d.count} (${d.pct}%)`;
    sb.appendChild(seg);
  });
  sbWrap.appendChild(sb);
  card.appendChild(sbWrap);

  // Breakdown pills
  const bd = el('div', 'breakdown');
  q.data.forEach((d, i) => {
    const pill = el('span', 'pill');
    pill.innerHTML = `<span class="dot" style="background:${pal[i].bg}"></span>${d.label}: <strong>${d.count}</strong> (${d.pct}%)`;
    bd.appendChild(pill);
  });
  card.appendChild(bd);

  // Chart canvas
  const area = el('div', 'chart-area');
  const canvas = document.createElement('canvas');
  canvas.id = 'ch_' + idx + '_' + Date.now();
  area.appendChild(canvas);
  card.appendChild(area);

  // Create chart after card is in DOM
  requestAnimationFrame(() => {
    const ctx = canvas.getContext('2d');
    const isCartesian = chartType === 'bar' || chartType === 'horizontalBar';
    const isRadar = chartType === 'radar';
    const type = chartType === 'horizontalBar' ? 'bar' : chartType;

    const bgColors = pal.map(p => p.bg + 'dd');
    const borderColors = pal.map(p => p.bg);

    const config = {
      type: type,
      data: {
        labels: labels,
        datasets: [{
          data: counts,
          backgroundColor: bgColors,
          borderColor: borderColors,
          borderWidth: 2,
          ...(isCartesian ? { borderRadius: 10, borderSkipped: false, barPercentage: 0.7, categoryPercentage: 0.75 } : {}),
          hoverBackgroundColor: borderColors,
          hoverBorderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: chartType === 'horizontalBar' ? 'y' : 'x',
        layout: { padding: { top: isCartesian ? 24 : 8, bottom: 4, left: 4, right: 4 } },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1a1a2e',
            titleFont: { family: 'DM Sans', weight: '600', size: 13 },
            bodyFont: { family: 'DM Sans', size: 12 },
            cornerRadius: 10,
            padding: 14,
            displayColors: true,
            boxPadding: 4,
            callbacks: {
              title: () => '',
              label: function(ctx) {
                const i = ctx.dataIndex;
                return ` ${labels[i]}:  ${counts[i]}  (${pcts[i]}%)`;
              }
            }
          },
        },
        scales: isCartesian ? {
          x: {
            grid: { display: false },
            ticks: { font: { family: 'DM Sans', size: 11, weight: '500' }, color: '#9ca3af' },
            border: { display: false },
          },
          y: {
            grid: { color: '#f3f4f6', drawBorder: false },
            ticks: { font: { family: 'DM Sans', size: 11, weight: '500' }, color: '#9ca3af' },
            border: { display: false },
            beginAtZero: true,
          }
        } : (isRadar ? {
          r: {
            beginAtZero: true,
            ticks: { display: false, stepSize: Math.ceil(Math.max(...counts) / 4) },
            grid: { color: '#e5e7eb' },
            pointLabels: { font: { family: 'DM Sans', size: 11 }, color: '#6b7280' },
          }
        } : {}),
        animation: {
          duration: 500,
          easing: 'easeOutCubic',
        },
      },
      plugins: [{
        /* Inline data-labels plugin â€” avoids CDN issues */
        id: 'customLabels',
        afterDatasetsDraw(chart) {
          const { ctx: c, data, chartArea } = chart;
          if (!chartArea) return;
          const meta = chart.getDatasetMeta(0);
          c.save();
          c.font = '700 11px "DM Sans", sans-serif';
          c.textAlign = 'center';

          meta.data.forEach((el, i) => {
            const val = data.datasets[0].data[i];
            if (val === 0) { return; }
            const pctStr = pcts[i] + '%';

            if (type === 'bar') {
              const isHoriz = chartType === 'horizontalBar';
              if (isHoriz) {
                c.fillStyle = '#374151';
                c.textAlign = 'left';
                c.textBaseline = 'middle';
                c.fillText(pctStr, el.x + 6, el.y);
              } else {
                c.fillStyle = '#374151';
                c.textBaseline = 'bottom';
                c.fillText(pctStr, el.x, el.y - 6);
              }
            } else if (type === 'doughnut' || type === 'pie') {
              // Place label on the arc
              const arc = el;
              const angle = (arc.startAngle + arc.endAngle) / 2;
              const r = (arc.innerRadius + arc.outerRadius) / 2;
              const x = arc.x + Math.cos(angle) * r;
              const y = arc.y + Math.sin(angle) * r;
              // Only show if big enough
              const angleDiff = arc.endAngle - arc.startAngle;
              if (angleDiff > 0.3) {
                c.fillStyle = '#fff';
                c.textBaseline = 'middle';
                c.fillText(pctStr, x, y);
              }
            } else if (type === 'polarArea') {
              const arc = el;
              const angle = (arc.startAngle + arc.endAngle) / 2;
              const r = arc.outerRadius * 0.65;
              const x = arc.x + Math.cos(angle) * r;
              const y = arc.y + Math.sin(angle) * r;
              const angleDiff = arc.endAngle - arc.startAngle;
              if (angleDiff > 0.3) {
                c.fillStyle = '#374151';
                c.textBaseline = 'middle';
                c.fillText(pctStr, x, y);
              }
            } else if (type === 'radar') {
              c.fillStyle = '#374151';
              c.textBaseline = 'bottom';
              const pointPos = el.getCenterPoint();
              c.fillText(val, pointPos.x, pointPos.y - 8);
            }
          });
          c.restore();
        }
      }]
    };

    const chart = new Chart(ctx, config);
    charts.push(chart);
  });

  return card;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LEGEND                                                          â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildLegend() {
  const lg = document.getElementById('colorLegend');
  lg.innerHTML = '';
  const items = [
    ['Muy satisfecho / SÃ­', '#22c55e'],
    ['Satisfecho', '#6ee7a0'],
    ['Neutral', '#eab308'],
    ['Insatisfecho', '#f97066'],
    ['Muy insatisfecho / No', '#dc2626'],
  ];
  items.forEach(([label, color]) => {
    const row = el('div', 'row');
    row.innerHTML = `<span class="swatch" style="background:${color}"></span>${label}`;
    lg.appendChild(row);
  });
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SECTION HEADING                                                 â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sectionHeading(title, count, type) {
  const d = el('div', 'section-heading');
  d.innerHTML = `<div class="icon ${type}">${type === 'likert' ? 'ğŸ“Š' : 'âœ…'}</div>
    <h2>${title}</h2><span class="count">${count} preguntas</span>`;
  return d;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  HELPERS                                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function el(tag, cls) {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  return e;
}

function showLoader(v) {
  document.getElementById('loader').classList.toggle('hidden', !v);
}
</script>
</body>
</html>
